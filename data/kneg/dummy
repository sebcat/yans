#!/usr/bin/env yans
Store = require"svcs.store"
YCFG = require"ycfg"

msgbuf = yans.ycl.msgbuf()
store = Store:new{path=YCFG.SVC_STORE, msgbuf = msgbuf}
yans.util.sandbox()
local id = store:enter{id=os.getenv("YANS_ID")}
print(id)
files = {
  {"noshowpls.txt", "wb", "pls no show"},
  {"report-10-foo.txt", "wb", "This is the foo report"},
  {"report-51-bar.txt.gz", "zlib:wb", "This is the bar report"},
  {"report-20-foo.csv", "wb", "foo,bar,baz\n1,2,3"},
  {"report-33-bar.csv.gz", "zlib:wb", "baz,bar,foo\n3,2,1\n"},
}

local flags = yans.file.O_WRONLY | yans.file.O_CREAT | yans.file.O_TRUNC
for _, e in ipairs(files) do
  store:open(e[1], flags):to_stream(e[2]):write(e[3]):close()
end

-- sleep a while to test the spinner in the UI
yans.util.nanosleep(5, 0)
