#include <stdio.h>
#include <string.h>
#include <stdlib.h>

#include <lib/net/ethframe.h>

int main() {
  struct ethframe frame;
  static const struct ethframe_icmp4_ereq_opts opts_icmp4 = {
    .eth_dst = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff},
    .eth_src = {0x00, 0x24, 0xd7, 0x17, 0x9c, 0x38},
    .ip_src = 0x1200a8c0, /* 192.168.0.18,  LSB order */
    .ip_dst = 0x010000e0, /* 224.0.0.1, LSB order */
    .ip_ttl = 1,
  };

  static const uint8_t expected_icmp4[] = {
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 0x24,
      0xd7, 0x17, 0x9c, 0x38, 0x08, 0x00, 0x45, 0x00,
      0x00, 0x24, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01,
      0x19, 0x1e, 0xc0, 0xa8, 0x00, 0x12, 0xe0, 0x00,
      0x00, 0x01, 0x08, 0x00, 0xf7, 0xff, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x01, 0x02, 0x03, 0xff, 0xfe,
      0xfd, 0xfc
  };

  static const struct ethframe_icmp6_ereq_opts opts_icmp6 = {
    .eth_dst = {0x33, 0x33, 0x00, 0x00, 0x00, 0x01},
    .eth_src = {0x00, 0x24, 0xd7, 0x17, 0x9c, 0x38},
    .ip_src = {
        0xfe, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x02, 0x24, 0xd7, 0xff, 0xfe, 0x17, 0x9c, 0x38
    },
    .ip_dst = {
        0xff, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01
    },
    .ip_hoplim = 64,
  };

  static const uint8_t expected_icmp6[] = {
     0x33, 0x33, 0x00, 0x00, 0x00, 0x01, 0x00, 0x24,
     0xd7, 0x17, 0x9c, 0x38, 0x86, 0xdd, 0x60, 0x00,
     0x00, 0x00, 0x00, 0x10, 0x3a, 0x40, 0xfe, 0x80,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x24,
     0xd7, 0xff, 0xfe, 0x17, 0x9c, 0x38, 0xff, 0x02,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x80, 0x00,
     0x0d, 0xbc, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
     0x02, 0x03, 0xff, 0xfe, 0xfd, 0xfc,
  };

  ethframe_icmp4_ereq_init(&frame, &opts_icmp4);
  if (frame.len != sizeof(expected_icmp4)) {
    fprintf(stderr, "icmp4: expected length %zu, was: %zu\n",
        sizeof(expected_icmp4), frame.len);
    return EXIT_FAILURE;
  } else if (memcmp(expected_icmp4, frame.buf, frame.len) != 0) {
    fprintf(stderr, "icmp4: expected package missmatch\n");
    return EXIT_FAILURE;
  }

  ethframe_icmp6_ereq_init(&frame, &opts_icmp6);
  if (frame.len != sizeof(expected_icmp6)) {
    fprintf(stderr, "icmp6: expected length %zu, was: %zu\n",
        sizeof(expected_icmp6), frame.len);
    return EXIT_FAILURE;
  } else if (memcmp(expected_icmp6, frame.buf, frame.len) != 0) {
    fprintf(stderr, "icmp6: expected package missmatch\n");
    return EXIT_FAILURE;
  }

  return 0;
}
